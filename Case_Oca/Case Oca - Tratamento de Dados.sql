-- Case - OCA

-- Objetivos:
-- - Identificar filmes com maiores renda e público

-- Conhecimentos aplicados
-- Estatística:
       -- - Análise exploratoria das variáveis qualitativas (Tabela de Frequência/Histograma)
       -- - Análise exploratoria das variáveis quantitativas (Medidas Resumo (Média, Soma e Contagem))
-- SQL:
       -- - Selecionar variáveis que quero visualizar de uma tabela (SELECT/FROM)
       -- - Comandos para exiição de medidas resumo (COUNT, SUM, AVG)
       -- - Comandos para análise de valores únicos (DISTINCT)
       -- - Análise de valores nulos (Count(1)-Count(variável))
       -- - Criar Filtros (WHERE) com auxílio das sintaxes condicionais (AND, OR, NOT) e comparação (<, >, !=)
       -- - Agrupar medidas resumos por categoria (GROUP BY)
       -- - Ordenar DataFrame (ORDER BY)
       -- - Criar colunas condicionais (CASE-WHEN-THEN-ELSE-END)
       -- - Conversão de tipo de variável (CAST)
       -- - Manipulação de String (CHARINDEX, SUBSTRING e DATALENGTH)
       -- - Criar tabelas dinâmicas (INTO), com finalidade de deixar o código mais "limpo"



SELECT
	*
FROM
	Henrique.dbo.oca


-- Avaliando se há valores NaN

SELECT
	COUNT(1)-COUNT([Ano de exibição]) AS 'Ano de Exibição',
	COUNT(1)-COUNT([Título da obra]) AS 'Título da obra',
	COUNT(1)-COUNT([CPB ROE]) AS 'CPB ROE',
	COUNT(1)-COUNT([Gênero]) AS 'Gênero',
	COUNT(1)-COUNT([País(es) produtor(es) da obra]) AS 'País produtor da obra',
	COUNT(1)-COUNT([Nacionalidade da obra]) AS 'Nacionalidade da obra',
	COUNT(1)-COUNT([Data de lançamento]) AS 'Data de Lançamento',
	COUNT(1)-COUNT([Empresa distribuidora]) AS 'Empresa distribuidora',
	COUNT(1)-COUNT([Origem da empresa distribuidora]) AS 'Origem da empresa distribuidora',
	COUNT(1)-COUNT([Público no ano de exibição]) AS 'Público no ano de exibição',
	COUNT(1)-COUNT([Renda (R$) no ano de exibição]) AS 'Renda($)'
FROM
	Henrique.dbo.oca

-- Avaliando contagem de valores únicos

SELECT
	COUNT(DISTINCT [Ano de exibição]) AS 'Ano de Exibição',
	COUNT(DISTINCT [Título da obra]) AS 'Título da obra',
	COUNT(DISTINCT [CPB ROE]) AS 'CPB ROE',
	COUNT(DISTINCT [Gênero]) AS 'Gênero',
	COUNT(DISTINCT [País(es) produtor(es) da obra]) AS 'País(es) produtor(es) da obra',
	COUNT(DISTINCT [Nacionalidade da obra]) AS 'Nacionalidade da obra',
	COUNT(DISTINCT [Data de lançamento]) AS 'Data de lançamento',
	COUNT(DISTINCT [Empresa distribuidora]) AS 'Empresa distribuidora',
	COUNT(DISTINCT [Origem da empresa distribuidora]) AS 'Origem da empresa distribuidora',
	COUNT(DISTINCT [Público no ano de exibição]) AS 'Público no ano de exibição',
	COUNT(DISTINCT [Renda (R$) no ano de exibição]) AS 'Renda (R$) no ano de exibição'
FROM
	Henrique.dbo.oca


-- Agupando quantidade de filmes pelo Ano de Exibição
SELECT
	[Ano de exibição],
	COUNT([Ano de exibição]) AS 'Data de lançamento'
FROM
	Henrique.dbo.oca
GROUP BY
	[Ano de exibição]
ORDER BY
	[Ano de exibição]

-- Tratamento de dados
-- Será necessário fazer um tratamento na coluna 'Renda' para conseguir efetuar a conversão do tipo de variável
-- Será necessário fazer um tratamento na coluna 'Público' para conseguir efetuar a conversão do tipo de variável

DROP TABLE IF EXISTS #tabela_teste1
SELECT
	*,
	CASE WHEN CHARINDEX(',',[Renda (R$) no ano de exibição]) != 0 THEN SUBSTRING([Renda (R$) no ano de exibição],1,DATALENGTH([Renda (R$) no ano de exibição])-3)
		 ELSE [Renda (R$) no ano de exibição]
	END AS 'Renda_tratado',
	REPLACE(CASE WHEN CHARINDEX(',',[Renda (R$) no ano de exibição]) != 0 THEN SUBSTRING([Renda (R$) no ano de exibição],1,DATALENGTH([Renda (R$) no ano de exibição])-3)
		 ELSE [Renda (R$) no ano de exibição]
	END,'.','') AS Renda_tratado_int,
	CAST(REPLACE([Público no ano de exibição],'.','') AS int) AS 'Público_tratado'
INTO
	#tabela_teste1
FROM
	Henrique.dbo.oca
WHERE
	[Renda (R$) no ano de exibição] != 'ND'

-- Filme com maior Renda
SELECT TOP 1
	*
FROM
	#tabela_teste1
ORDER BY
	CAST(Renda_tratado_int AS int) DESC

-- TOP 5 filmes com maiores rendas
SELECT TOP 5
	*
FROM
	#tabela_teste1
ORDER BY
	CAST(Renda_tratado_int AS int) DESC


-- Análise de filmes com maiores públicos

SELECT TOP 5
	*
FROM
	#tabela_teste1
ORDER BY
	Público_tratado DESC

-- Análise do R$/Pessoas

SELECT
	[Título da obra],
	Público_tratado,
	CAST(Renda_tratado_int AS int) AS 'Renda',
	CASE WHEN Público_tratado!=0 THEN CAST(Renda_tratado_int AS int)/Público_tratado
		ELSE 0
	END AS 'R$/Pessoa',
	[Ano de exibição]
FROM
	#tabela_teste1
ORDER BY
	CAST(Renda_tratado_int AS int) DESC



